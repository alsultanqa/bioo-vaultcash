import {Request,Response,NextFunction} from 'express'; const B=new Map<string,{count:number;resetAt:number}>(); const L=Number(process.env.RATE_LIMIT||60),W=6e4; export function rateLimit(req:Request,res:Response,next:NextFunction){const k=req.ip||'anon',n=Date.now();const b=B.get(k)||{count:0,resetAt:n+W}; if(n>b.resetAt){b.count=0;b.resetAt=n+W} b.count++; B.set(k,b); res.setHeader('X-RateLimit-Limit',String(L)); res.setHeader('X-RateLimit-Remaining',String(Math.max(0,L-b.count))); res.setHeader('X-RateLimit-Reset',String(Math.ceil(b.resetAt/1000))); if(b.count>L) return res.status(429).json({error:'rate_limited'}); next(); }
