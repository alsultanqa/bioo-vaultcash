name: Deploy Backend to Elastic Beanstalk (safe)

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend-eb.yml"
  workflow_dispatch:

env:
  # Ù„Ùˆ ØªÙØ¶Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Variables ÙÙŠ GitHub
  AWS_REGION: ${{ vars.AWS_REGION }}
  EB_APP_NAME: ${{ vars.EB_APP_NAME }}
  EB_ENV_NAME: ${{ vars.EB_ENV_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) ØªØ­Ù‚Ù‘Ù‚ Ù…Ø¨ÙƒØ± Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ø¯Ø§Ø®Ù„ backend
      - name: Sanity check project structure
        run: |
          set -e
          [ -d backend ] || { echo "::error::Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¬Ù„Ø¯ backend/"; exit 1; }
          [ -f backend/package.json ] || { echo "::error::backend/package.json ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"; exit 1; }
          [ -f backend/Procfile ] || echo "::warning::Ù„Ù… Ø£Ø¬Ø¯ backend/Procfile. Elastic Beanstalk ÙŠØ­ØªØ§Ø¬ Ù†Ù‚Ø·Ø© ØªØ´ØºÙŠÙ„ (Ù…Ø«Ù„Ø§Ù‹: web: node server.js)."
          jq -r '.name,.version' backend/package.json >/dev/null 2>&1 || { echo "::error::package.json ØºÙŠØ± ØµØ§Ù„Ø­ (JSON)"; exit 1; }

      # 2) ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù€ Secrets
      - name: Validate required secrets exist
        run: |
          req=(AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_ACCOUNT_ID)
          for k in "${req[@]}"; do
            if [ -z "${{ secrets[k] }}" ]; then
              echo "::error::Secret $k Ù…ÙÙ‚ÙˆØ¯ ÙÙŠ Settings â†’ Secrets and variables â†’ Actions"
              exit 1
            fi
          done
          echo "All required secrets exist âœ…"

      # 3) ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Variables
      - name: Validate required variables exist
        run: |
          req=(AWS_REGION EB_APP_NAME EB_ENV_NAME)
          for k in "${req[@]}"; do
            v="${!k}"
            if [ -z "$v" ]; then
              echo "::error::Variable $k Ù…ÙÙ‚ÙˆØ¯ (Settings â†’ Secrets and variables â†’ Actions â†’ Variables)"
              exit 1
            fi
            echo "$k=$v"
          done

      # 4) Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø¹ØªÙ…Ø§Ø¯ AWS ÙˆØ§Ø®ØªØ¨Ø§Ø±Ù‡
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity & region
        run: |
          set -e
          ACC="$(aws sts get-caller-identity --query Account --output text)"
          echo "Connected to AWS Account: $ACC (expected: ${{ secrets.AWS_ACCOUNT_ID }})"
          if [ "$ACC" != "${{ secrets.AWS_ACCOUNT_ID }}" ]; then
            echo "::error::Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ AWS_ACCOUNT_ID"; exit 1
          fi
          aws ec2 describe-availability-zones --query 'AvailabilityZones[0].ZoneName' --output text >/dev/null
          echo "Region $AWS_REGION reachable âœ…"

      # 5) ØªØ£ÙƒØ¯ Ø£Ù† Application & Environment Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
      - name: Check EB application/environment
        run: |
          set -e
          app_ok=$(aws elasticbeanstalk describe-applications \
            --application-names "$EB_APP_NAME" \
            --query 'Applications[0].ApplicationName' --output text || true)
          [ "$app_ok" != "None" ] || { echo "::error::EB Application '$EB_APP_NAME' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"; exit 1; }

          env_ok=$(aws elasticbeanstalk describe-environments \
            --application-name "$EB_APP_NAME" \
            --query "Environments[?EnvironmentName=='$EB_ENV_NAME'].Status | [0]" --output text || true)
          [ "$env_ok" != "None" ] || { echo "::error::EB Environment '$EB_ENV_NAME' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"; exit 1; }
          echo "EB app/env found âœ…"

      # 6) Ø¥Ø¹Ø¯Ø§Ø¯ node ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install deps
        working-directory: backend
        run: npm ci

      - name: Prisma generate (optional)
        working-directory: backend
        run: npx prisma generate || echo "no prisma schema"

      - name: Build (optional)
        working-directory: backend
        run: npm run build || echo "no build script"

      - name: Zip deployment package
        run: |
          cd backend
          zip -r ../backend.zip . -x "**/.git**" "**/node_modules/**"
          ls -lh ../backend.zip

      # 7) Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù†Ø´Ø± (A) â€” Ø¹Ø¨Ø± beanstalk-deploy (Ø£Ø³Ù‡Ù„)
      - name: Deploy to Elastic Beanstalk (beanstalk-deploy)
        id: eb1
        continue-on-error: true
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: ${{ env.EB_APP_NAME }}
          environment_name: ${{ env.EB_ENV_NAME }}
          region: ${{ env.AWS_REGION }}
          version_label: v-${{ github.run_number }}
          deployment_package: backend.zip

      # 7-b) Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© â€” Ù„Ùˆ ÙØ´Ù„Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù†Ø³ØªØ®Ø¯Ù… AWS CLI Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø¶Ø­Ø©
      - name: Fallback deploy via AWS CLI
        if: steps.eb1.outcome == 'failure'
        run: |
          set -e
          APP_BUCKET="elasticbeanstalk-${AWS_REGION}-${{ secrets.AWS_ACCOUNT_ID }}"
          S3_KEY="${EB_APP_NAME}/build-${{ github.run_number }}.zip"
          echo "Uploading to s3://$APP_BUCKET/$S3_KEY"
          aws s3 cp backend.zip s3://$APP_BUCKET/$S3_KEY

          echo "Create application version..."
          aws elasticbeanstalk create-application-version \
            --application-name "$EB_APP_NAME" \
            --version-label "build-${{ github.run_number }}" \
            --source-bundle S3Bucket="$APP_BUCKET",S3Key="$S3_KEY"

          echo "Update environment..."
          aws elasticbeanstalk update-environment \
            --environment-name "$EB_ENV_NAME" \
            --version-label "build-${{ github.run_number }}"

      - name: Done
        run: echo "ğŸ‰ Deployment pipeline finished."
