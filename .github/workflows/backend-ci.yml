name: Backend CI (tests + prisma)
on:
  push:
    branches: [ main ]
    paths: [ 'backend/**', '.github/workflows/backend-ci.yml' ]
  pull_request:
    paths: [ 'backend/**' ]
jobs:
  ci:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env: { POSTGRES_USER: user, POSTGRES_PASSWORD: pass, POSTGRES_DB: qatarchash }
        ports: [ "5432:5432" ]
        options: >-
          --health-cmd="pg_isready -U user -d qatarchash"
          --health-interval=10s --health-timeout=5s --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: cd backend && npm ci && npx prisma generate
      - env: { DATABASE_URL: postgresql://user:pass@localhost:5432/qatarchash }
        run: cd backend && npx prisma migrate deploy
      - env: { DATABASE_URL: postgresql://user:pass@localhost:5432/qatarchash }
        run: cd backend && npm test --silent
